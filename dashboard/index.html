<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CPI Bot Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:          #f1f5f9;
      --surface:     #ffffff;
      --surface2:    #f8fafc;
      --border:      #e2e8f0;
      --text:        #1e293b;
      --text-muted:  #64748b;
      --text-light:  #94a3b8;
      --green:       #10b981;
      --green-light: #ecfdf5;
      --red:         #ef4444;
      --red-light:   #fef2f2;
      --blue:        #3b82f6;
      --blue-light:  #eff6ff;
      --shadow-sm:   0 1px 2px rgba(0,0,0,0.05);
      --shadow:      0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-md:   0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
      --radius:      12px;
      --radius-sm:   8px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', -apple-system, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }

    .logo {
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.3px;
    }

    .logo span { color: var(--blue); }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 12px;
      border-radius: 100px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-badge.running { background: var(--green-light); color: var(--green); }
    .status-badge.halted  { background: var(--red-light);   color: var(--red); }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.4; }
    }

    .mode-tag {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      background: var(--blue-light);
      color: var(--blue);
      letter-spacing: 0.05em;
    }

    .clock {
      font-size: 13px;
      color: var(--text-muted);
      font-variant-numeric: tabular-nums;
    }

    /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
    main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* ‚îÄ‚îÄ SHARED CARD ‚îÄ‚îÄ */
    .card {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 20px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    /* ‚îÄ‚îÄ CIRCUIT BREAKER BANNER ‚îÄ‚îÄ */
    .cb-banner {
      display: none;
      align-items: center;
      gap: 8px;
      background: var(--red-light);
      border: 1px solid #fca5a5;
      border-radius: var(--radius-sm);
      padding: 12px 16px;
      color: var(--red);
      font-size: 13px;
      font-weight: 500;
    }

    .cb-banner.visible { display: flex; }

    /* ‚îÄ‚îÄ HERO METRICS ROW ‚îÄ‚îÄ */
    .metrics-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
      gap: 16px;
    }

    .metric-card {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 20px;
    }

    .metric-card.hero {
      background: var(--blue);
      border-color: var(--blue);
    }

    .metric-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .metric-card.hero .metric-label { color: rgba(255,255,255,0.75); }

    .metric-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--text);
      letter-spacing: -0.5px;
      line-height: 1;
    }

    .metric-card.hero .metric-value {
      font-size: 34px;
      color: white;
    }

    .metric-sub {
      font-size: 12px;
      margin-top: 6px;
      color: var(--text-muted);
    }

    .metric-card.hero .metric-sub { color: rgba(255,255,255,0.7); }

    .metric-up   { color: var(--green) !important; }
    .metric-down { color: var(--red)   !important; }

    .pnl-bar {
      margin-top: 14px;
      height: 4px;
      background: rgba(255,255,255,0.25);
      border-radius: 2px;
      overflow: hidden;
    }

    .pnl-bar-fill {
      height: 100%;
      background: rgba(255,255,255,0.85);
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    /* ‚îÄ‚îÄ EQUITY CHART ‚îÄ‚îÄ */
    .chart-card {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 20px;
    }

    .chart-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .chart-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
    }

    .range-group {
      display: flex;
      gap: 2px;
      background: var(--bg);
      border-radius: 8px;
      padding: 3px;
    }

    .range-btn {
      padding: 5px 14px;
      border-radius: 6px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      transition: all 0.15s;
    }

    .range-btn.active {
      background: white;
      color: var(--text);
      box-shadow: var(--shadow-sm);
    }

    .chart-wrap { height: 200px; }

    /* ‚îÄ‚îÄ THREE COLUMNS ‚îÄ‚îÄ */
    .three-col {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
    }

    /* ‚îÄ‚îÄ FORECAST ‚îÄ‚îÄ */
    .forecast-hero {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      margin-bottom: 16px;
    }

    .forecast-number {
      font-size: 38px;
      font-weight: 800;
      letter-spacing: -1px;
      color: var(--text);
      line-height: 1;
    }

    .forecast-sigma {
      font-size: 13px;
      color: var(--text-muted);
      padding-bottom: 5px;
    }

    .model-row { display: flex; flex-direction: column; gap: 6px; }

    .model-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 9px 12px;
      background: var(--surface2);
      border-radius: var(--radius-sm);
    }

    .model-name { font-size: 13px; font-weight: 500; color: var(--text-muted); }
    .model-val  { font-size: 13px; font-weight: 700; color: var(--text); }
    .model-val.highlight { color: var(--blue); }

    /* ‚îÄ‚îÄ PERFORMANCE ‚îÄ‚îÄ */
    .perf-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .perf-item {
      padding: 12px;
      background: var(--surface2);
      border-radius: var(--radius-sm);
    }

    .perf-label { font-size: 11px; font-weight: 500; color: var(--text-muted); margin-bottom: 4px; }
    .perf-value { font-size: 16px; font-weight: 700; color: var(--text); }

    /* ‚îÄ‚îÄ MARKETS ‚îÄ‚îÄ */
    .market-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin-bottom: 7px;
    }

    .market-item:last-child { margin-bottom: 0; }

    .market-bucket {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      min-width: 72px;
    }

    .market-probs {
      display: flex;
      gap: 14px;
      flex: 1;
    }

    .market-prob-item { text-align: center; }
    .market-prob-label { font-size: 10px; color: var(--text-light); margin-bottom: 2px; }
    .market-prob-val { font-size: 13px; font-weight: 700; }
    .market-prob-val.model  { color: var(--blue); }
    .market-prob-val.market { color: var(--text); }

    .edge-tag {
      font-size: 11px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 6px;
      white-space: nowrap;
    }

    .edge-tag.buy  { background: var(--green-light); color: var(--green); }
    .edge-tag.sell { background: var(--red-light);   color: var(--red); }
    .edge-tag.none { background: var(--bg);          color: var(--text-light); font-weight: 500; }

    /* ‚îÄ‚îÄ TRADES TABLE ‚îÄ‚îÄ */
    .tabs {
      display: flex;
      gap: 2px;
      background: var(--bg);
      border-radius: 10px;
      padding: 4px;
      margin-bottom: 16px;
      width: fit-content;
    }

    .tab-btn {
      padding: 7px 16px;
      border-radius: 7px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      transition: all 0.15s;
    }

    .tab-btn.active {
      background: white;
      color: var(--text);
      font-weight: 600;
      box-shadow: var(--shadow-sm);
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .trades-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .trades-table th {
      text-align: left;
      padding: 8px 12px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      border-bottom: 1px solid var(--border);
    }

    .trades-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
    }

    .trades-table tbody tr:last-child td { border-bottom: none; }
    .trades-table tbody tr:hover { background: var(--surface2); }

    .side-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
    }

    .side-tag.buy  { background: var(--green-light); color: var(--green); }
    .side-tag.sell { background: var(--red-light);   color: var(--red); }

    .status-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-tag.open         { background: var(--blue-light);  color: var(--blue); }
    .status-tag.settled-win  { background: var(--green-light); color: var(--green); }
    .status-tag.settled-loss { background: var(--red-light);   color: var(--red); }
    .status-tag.settled      { background: var(--bg);          color: var(--text-muted); }

    /* ‚îÄ‚îÄ MANUAL FORM ‚îÄ‚îÄ */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 5px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      color: var(--text);
      background: white;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .form-group input:focus,
    .form-group select:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
    }

    /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
    .btn {
      padding: 9px 20px;
      border-radius: var(--radius-sm);
      border: none;
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-primary { background: var(--blue); color: white; }
    .btn-primary:hover { background: #2563eb; }

    .btn-success { background: var(--green-light); color: var(--green); }
    .btn-success:hover { background: #d1fae5; }

    .btn-danger { background: var(--red-light); color: var(--red); }
    .btn-danger:hover { background: #fee2e2; }

    .btn-sm { padding: 5px 12px; font-size: 12px; }

    /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
    .empty-state {
      text-align: center;
      padding: 36px;
      color: var(--text-muted);
    }

    .empty-icon { font-size: 28px; margin-bottom: 8px; }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    #toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px 18px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: var(--shadow-md);
      max-width: 320px;
      opacity: 0;
      transform: translateY(8px);
      transition: all 0.2s;
      z-index: 1000;
    }

    #toast.show { opacity: 1; transform: translateY(0); }
    #toast.success { border-left: 3px solid var(--green); }
    #toast.error   { border-left: 3px solid var(--red); }

    /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
    @media (max-width: 1100px) {
      .metrics-row { grid-template-columns: 1fr 1fr 1fr; }
      .metric-card.hero { grid-column: span 3; }
      .three-col { grid-template-columns: 1fr 1fr; }
    }

    @media (max-width: 700px) {
      main { padding: 12px; gap: 12px; }
      .metrics-row { grid-template-columns: 1fr 1fr; }
      .metric-card.hero { grid-column: span 2; }
      .three-col { grid-template-columns: 1fr; }
      .form-grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">CPI <span>Kalshi</span> Bot</div>
  <div class="header-right">
    <span id="status-badge" class="status-badge running">
      <span class="status-dot"></span>
      <span id="status-text">Running</span>
    </span>
    <span id="mode-tag" class="mode-tag">PAPER</span>
    <span class="clock" id="clock">--:--:-- ET</span>
  </div>
</header>

<main>

  <!-- CIRCUIT BREAKER BANNER -->
  <div id="cb-banner" class="cb-banner">
    ‚ö†Ô∏è <span id="cb-text">Circuit breaker active</span>
  </div>

  <!-- HERO METRICS -->
  <div class="metrics-row">
    <div class="metric-card hero">
      <div class="metric-label">Portfolio Value</div>
      <div class="metric-value" id="portfolio-value">$25,000</div>
      <div class="metric-sub" id="portfolio-sub">Paper trading account</div>
      <div class="pnl-bar">
        <div class="pnl-bar-fill" id="pnl-bar" style="width:50%"></div>
      </div>
    </div>

    <div class="metric-card">
      <div class="metric-label">Realized P&L</div>
      <div class="metric-value" id="realized-pnl">$0</div>
      <div class="metric-sub" id="pnl-pct">+0.00% return</div>
    </div>

    <div class="metric-card">
      <div class="metric-label">Win Rate</div>
      <div class="metric-value" id="win-rate">‚Äî</div>
      <div class="metric-sub" id="win-count">No settled trades</div>
    </div>

    <div class="metric-card">
      <div class="metric-label">Sharpe Ratio</div>
      <div class="metric-value" id="sharpe">‚Äî</div>
      <div class="metric-sub">Annualized</div>
    </div>

    <div class="metric-card">
      <div class="metric-label">Open Exposure</div>
      <div class="metric-value" id="exposure">$0</div>
      <div class="metric-sub" id="open-positions">0 open positions</div>
    </div>
  </div>

  <!-- EQUITY CURVE -->
  <div class="chart-card">
    <div class="chart-controls">
      <div>
        <div style="font-size:12px;font-weight:500;color:var(--text-muted);margin-bottom:3px;">Equity Curve</div>
        <div class="chart-value" id="chart-current">$25,000</div>
      </div>
      <div class="range-group">
        <button class="range-btn active" onclick="loadChart(30, this)">30D</button>
        <button class="range-btn" onclick="loadChart(60, this)">60D</button>
        <button class="range-btn" onclick="loadChart(90, this)">90D</button>
      </div>
    </div>
    <div class="chart-wrap">
      <canvas id="equity-chart"></canvas>
    </div>
  </div>

  <!-- THREE COLUMNS -->
  <div class="three-col">

    <!-- CPI Forecast -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">CPI Forecast</span>
        <span id="forecast-period" style="font-size:12px;color:var(--text-muted);">‚Äî</span>
      </div>
      <div class="forecast-hero">
        <div class="forecast-number" id="forecast-mu">‚Äî</div>
        <div class="forecast-sigma" id="forecast-sigma">œÉ ‚Äî</div>
      </div>
      <div class="model-row">
        <div class="model-item">
          <span class="model-name">Ridge</span>
          <span class="model-val" id="comp-ridge">‚Äî</span>
        </div>
        <div class="model-item">
          <span class="model-name">XGBoost</span>
          <span class="model-val" id="comp-xgb">‚Äî</span>
        </div>
        <div class="model-item">
          <span class="model-name">Cleveland Fed</span>
          <span class="model-val" id="comp-clev">‚Äî</span>
        </div>
        <div class="model-item">
          <span class="model-name">Ensemble (final)</span>
          <span class="model-val highlight" id="comp-ens">‚Äî</span>
        </div>
      </div>
    </div>

    <!-- Performance -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">Performance</span>
      </div>
      <div class="perf-grid">
        <div class="perf-item">
          <div class="perf-label">Best Trade</div>
          <div class="perf-value metric-up" id="perf-best">$‚Äî</div>
        </div>
        <div class="perf-item">
          <div class="perf-label">Worst Trade</div>
          <div class="perf-value metric-down" id="perf-worst">$‚Äî</div>
        </div>
        <div class="perf-item">
          <div class="perf-label">Avg per Trade</div>
          <div class="perf-value" id="perf-avg">$‚Äî</div>
        </div>
        <div class="perf-item">
          <div class="perf-label">Total Fees</div>
          <div class="perf-value metric-down" id="perf-fees">$‚Äî</div>
        </div>
        <div class="perf-item">
          <div class="perf-label">Total Trades</div>
          <div class="perf-value" id="total-trades">‚Äî</div>
        </div>
        <div class="perf-item">
          <div class="perf-label">Avg Edge</div>
          <div class="perf-value" id="avg-edge">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- Live Markets -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">Live Markets</span>
        <span id="market-count" style="font-size:12px;color:var(--text-muted);">‚Äî</span>
      </div>
      <div id="markets-list">
        <div class="empty-state">
          <div class="empty-icon">üìä</div>
          <div>No market data yet.<br>Bot will populate on next scan.</div>
        </div>
      </div>
    </div>

  </div>

  <!-- TRADE LOG -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">Trade Log</span>
    </div>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('all', this)">All Trades</button>
      <button class="tab-btn" onclick="switchTab('open', this)">Open</button>
      <button class="tab-btn" onclick="switchTab('settled', this)">Settled</button>
      <button class="tab-btn" onclick="switchTab('manual', this)">+ Log Trade</button>
    </div>

    <div id="tab-all" class="tab-content active">
      <div id="trades-table-wrapper">
        <div class="empty-state"><div class="empty-icon">üìã</div><div>No trades yet.</div></div>
      </div>
    </div>

    <div id="tab-open" class="tab-content">
      <div id="open-trades-wrapper">
        <div class="empty-state"><div class="empty-icon">‚è≥</div><div>No open positions.</div></div>
      </div>
    </div>

    <div id="tab-settled" class="tab-content">
      <div id="settled-trades-wrapper">
        <div class="empty-state"><div class="empty-icon">‚úÖ</div><div>No settled trades.</div></div>
      </div>
    </div>

    <div id="tab-manual" class="tab-content">
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:18px;">
        Manually log a paper trade you placed on Kalshi.
      </p>
      <form id="manual-trade-form">
        <div class="form-grid">
          <div class="form-group">
            <label>Market ID</label>
            <input type="text" id="mt-market-id" placeholder="e.g. CPI-24-JAN-315" required>
          </div>
          <div class="form-group">
            <label>Side</label>
            <select id="mt-side" required>
              <option value="BUY">BUY (Yes)</option>
              <option value="SELL">SELL (No)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Contracts</label>
            <input type="number" id="mt-contracts" min="1" placeholder="100" required>
          </div>
          <div class="form-group">
            <label>Price (0‚Äì1)</label>
            <input type="number" id="mt-price" min="0.01" max="0.99" step="0.01" placeholder="0.45" required>
          </div>
          <div class="form-group">
            <label>Net Edge</label>
            <input type="number" id="mt-edge" step="0.01" placeholder="0.06">
          </div>
          <div class="form-group">
            <label>Model Probability</label>
            <input type="number" id="mt-pmodel" step="0.01" placeholder="0.52">
          </div>
          <div class="form-group">
            <label>Market Probability</label>
            <input type="number" id="mt-pmarket" step="0.01" placeholder="0.45">
          </div>
          <div class="form-group">
            <label>Reference Period</label>
            <input type="date" id="mt-period" required>
          </div>
          <div class="form-group">
            <label>Notes (optional)</label>
            <input type="text" id="mt-notes" placeholder="Optional notes">
          </div>
        </div>
        <div style="margin-top:18px;">
          <button type="submit" class="btn btn-primary">Log Trade</button>
        </div>
      </form>
    </div>

  </div>

</main>

<div id="toast"></div>

<script>
const API = '';

// ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ
function updateClock() {
  const et = new Date().toLocaleTimeString('en-US', {
    timeZone: 'America/New_York',
    hour12: false,
    hour: '2-digit', minute: '2-digit', second: '2-digit'
  });
  document.getElementById('clock').textContent = `${et} ET`;
}
setInterval(updateClock, 1000);
updateClock();

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function toast(msg, type = 'success') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `show ${type}`;
  setTimeout(() => el.className = '', 3000);
}

// ‚îÄ‚îÄ API HELPERS ‚îÄ‚îÄ
async function api(endpoint) {
  const r = await fetch(API + endpoint);
  if (!r.ok) throw new Error(`${r.status} ${endpoint}`);
  return r.json();
}

async function post(endpoint, body) {
  const r = await fetch(API + endpoint, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!r.ok) throw new Error(`${r.status} ${endpoint}`);
  return r.json();
}

// ‚îÄ‚îÄ FORMAT HELPERS ‚îÄ‚îÄ
function fmt$(n, showSign = false) {
  if (n == null) return '$‚Äî';
  const abs = Math.abs(n).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  const sign = n < 0 ? '-' : showSign ? '+' : '';
  return `${sign}$${abs}`;
}

function fmtPct(n) {
  if (n == null) return '‚Äî';
  return `${n >= 0 ? '+' : ''}${n.toFixed(2)}%`;
}

// ‚îÄ‚îÄ PORTFOLIO ‚îÄ‚îÄ
async function loadPortfolio() {
  try {
    const d = await api('/api/portfolio');
    const valStr = `$${d.total_value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
    document.getElementById('portfolio-value').textContent = valStr;
    document.getElementById('chart-current').textContent = valStr;

    const pnlEl = document.getElementById('realized-pnl');
    pnlEl.textContent = fmt$(d.realized_pnl, true);
    pnlEl.className = `metric-value ${d.realized_pnl >= 0 ? 'metric-up' : 'metric-down'}`;

    document.getElementById('pnl-pct').textContent = `${fmtPct(d.pnl_pct)} return`;
    document.getElementById('portfolio-sub').textContent =
      `Started at $${(d.starting_capital || 25000).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;

    const barPct = Math.min(100, Math.max(0, 50 + (d.pnl_pct || 0) * 2.5));
    document.getElementById('pnl-bar').style.width = `${barPct}%`;

    document.getElementById('exposure').textContent =
      `$${(d.total_exposure || 0).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
    document.getElementById('open-positions').textContent =
      `${d.num_open_positions || 0} open position${d.num_open_positions !== 1 ? 's' : ''}`;

    document.getElementById('mode-tag').textContent = (d.mode || 'paper').toUpperCase();
  } catch(e) { console.error('Portfolio:', e); }
}

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ
async function loadStats() {
  try {
    const d = await api('/api/trades/stats');
    document.getElementById('win-rate').textContent = d.total_trades ? `${d.win_rate}%` : '‚Äî';
    document.getElementById('win-count').textContent = d.total_trades
      ? `${d.total_wins} of ${d.total_trades} trades`
      : 'No settled trades';
    document.getElementById('sharpe').textContent = d.total_trades ? d.sharpe.toFixed(2) : '‚Äî';
    document.getElementById('avg-edge').textContent = d.avg_edge ? `${(d.avg_edge * 100).toFixed(1)}¬¢` : '‚Äî';
    document.getElementById('total-trades').textContent = d.total_trades || '‚Äî';
    document.getElementById('perf-best').textContent  = fmt$(d.best_trade, true);
    document.getElementById('perf-worst').textContent = fmt$(d.worst_trade, true);
    document.getElementById('perf-avg').textContent   = fmt$(d.avg_pnl_per_trade, true);
    document.getElementById('perf-fees').textContent  = `$${(d.total_fees || 0).toFixed(2)}`;
  } catch(e) { console.error('Stats:', e); }
}

// ‚îÄ‚îÄ EQUITY CHART ‚îÄ‚îÄ
let equityChart = null;

async function loadChart(days = 30, btn = null) {
  if (btn) {
    document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }
  try {
    const d = await api(`/api/portfolio/equity-curve?days=${days}`);
    const curve = d.curve;
    const labels = curve.map(p => p.date);
    const values = curve.map(p => p.value);
    const isUp = values.length && values[values.length - 1] >= d.starting_capital;
    const lineColor = isUp ? '#10b981' : '#ef4444';
    const fillColor = isUp ? 'rgba(16,185,129,0.08)' : 'rgba(239,68,68,0.08)';

    const ctx = document.getElementById('equity-chart').getContext('2d');
    if (equityChart) equityChart.destroy();
    equityChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          data: values,
          borderColor: lineColor,
          borderWidth: 2,
          backgroundColor: fillColor,
          fill: true,
          tension: 0.3,
          pointRadius: 0,
          pointHoverRadius: 5,
          pointHoverBackgroundColor: lineColor
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'white',
            borderColor: '#e2e8f0',
            borderWidth: 1,
            titleColor: '#64748b',
            bodyColor: '#1e293b',
            titleFont: { family: 'Inter', size: 11 },
            bodyFont: { family: 'Inter', size: 13, weight: '600' },
            callbacks: {
              label: ctx => `$${ctx.raw.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`
            }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { color: '#94a3b8', font: { family: 'Inter', size: 11 }, maxTicksLimit: 6, maxRotation: 0 },
            border: { color: '#e2e8f0' }
          },
          y: {
            grid: { color: '#f1f5f9' },
            ticks: {
              color: '#94a3b8',
              font: { family: 'Inter', size: 11 },
              callback: v => `$${(v / 1000).toFixed(0)}k`
            },
            border: { display: false }
          }
        }
      }
    });
  } catch(e) { console.error('Chart:', e); }
}

// ‚îÄ‚îÄ FORECASTS ‚îÄ‚îÄ
async function loadForecasts() {
  try {
    const d = await api('/api/forecasts/latest?limit=1');
    if (!d.forecasts.length) return;
    const f = d.forecasts[0];
    document.getElementById('forecast-period').textContent = f.reference_period;
    document.getElementById('forecast-mu').textContent =
      `${f.mu_model >= 0 ? '+' : ''}${f.mu_model.toFixed(3)}%`;
    document.getElementById('forecast-sigma').textContent = `œÉ ${f.sigma_model.toFixed(3)}%`;
    document.getElementById('comp-ridge').textContent = f.mu_ridge  != null ? `${f.mu_ridge.toFixed(3)}%`    : '‚Äî';
    document.getElementById('comp-xgb').textContent   = f.mu_xgboost != null ? `${f.mu_xgboost.toFixed(3)}%` : '‚Äî';
    document.getElementById('comp-clev').textContent  = f.mu_cleveland != null ? `${f.mu_cleveland.toFixed(3)}%` : '‚Äî';
    document.getElementById('comp-ens').textContent   = f.mu_model != null ? `${f.mu_model.toFixed(3)}%`    : '‚Äî';
  } catch(e) { console.error('Forecasts:', e); }
}

// ‚îÄ‚îÄ MARKETS ‚îÄ‚îÄ
async function loadMarkets() {
  try {
    const d = await api('/api/markets/current');
    const list = document.getElementById('markets-list');
    document.getElementById('market-count').textContent = `${d.markets.length} markets`;
    if (!d.markets.length) {
      list.innerHTML = `<div class="empty-state"><div class="empty-icon">üìä</div><div>No market data yet.</div></div>`;
      return;
    }
    list.innerHTML = d.markets.map(m => {
      const edge = m.net_edge || 0;
      const hasEdgeBuy  = edge >  0.04;
      const hasEdgeSell = edge < -0.04;
      const edgeText  = hasEdgeBuy  ? `‚ñ≤ BUY +${(edge * 100).toFixed(1)}¬¢`
                      : hasEdgeSell ? `‚ñº SELL +${(Math.abs(edge) * 100).toFixed(1)}¬¢`
                      : 'No edge';
      const edgeClass = hasEdgeBuy ? 'buy' : hasEdgeSell ? 'sell' : 'none';
      const bucket    = m.bucket_high > 900  ? `>${m.bucket_low}%`
                      : m.bucket_low  < -900 ? `<${m.bucket_high}%`
                      : `${m.bucket_low}‚Äì${m.bucket_high}%`;
      return `<div class="market-item">
        <div class="market-bucket">${bucket}</div>
        <div class="market-probs">
          <div class="market-prob-item">
            <div class="market-prob-label">Model</div>
            <div class="market-prob-val model">${m.p_model != null ? (m.p_model * 100).toFixed(1) + '%' : '‚Äî'}</div>
          </div>
          <div class="market-prob-item">
            <div class="market-prob-label">Market</div>
            <div class="market-prob-val market">${m.mid_price != null ? (m.mid_price * 100).toFixed(1) + '%' : '‚Äî'}</div>
          </div>
        </div>
        <span class="edge-tag ${edgeClass}">${edgeText}</span>
      </div>`;
    }).join('');
  } catch(e) { console.error('Markets:', e); }
}

// ‚îÄ‚îÄ TRADES ‚îÄ‚îÄ
function buildTradeTable(trades, includeSettle = false) {
  if (!trades.length) {
    return `<div class="empty-state"><div class="empty-icon">üìã</div><div>No trades found.</div></div>`;
  }
  return `<div style="overflow-x:auto;">
    <table class="trades-table">
      <thead><tr>
        <th>Market</th><th>Period</th><th>Time</th>
        <th>Side</th><th>Qty</th><th>Price</th>
        <th>Cost</th><th>Edge</th><th>Status</th><th>P&L</th>
        ${includeSettle ? '<th></th>' : ''}
      </tr></thead>
      <tbody>
        ${trades.map(t => {
          const pnlColor   = t.pnl_net > 0 ? 'var(--green)' : t.pnl_net < 0 ? 'var(--red)' : '';
          const statusClass = t.status === 'open' ? 'open'
                            : t.outcome === true  ? 'settled-win'
                            : t.outcome === false ? 'settled-loss' : 'settled';
          const statusLabel = t.status === 'open' ? 'Open'
                            : t.outcome === true  ? 'Won'
                            : t.outcome === false ? 'Lost' : 'Settled';
          return `<tr>
            <td style="max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text-muted);font-size:12px;">${t.market_id}</td>
            <td style="font-size:12px;">${t.reference_period || '‚Äî'}</td>
            <td style="color:var(--text-muted);font-size:12px;">${t.trade_time ? t.trade_time.slice(0,16).replace('T',' ') : '‚Äî'}</td>
            <td><span class="side-tag ${(t.side||'').toLowerCase()}">${t.side}</span></td>
            <td>${t.contracts}</td>
            <td>${t.price != null ? (t.price * 100).toFixed(0) + '¬¢' : '‚Äî'}</td>
            <td>${t.total_cost != null ? fmt$(t.total_cost) : '‚Äî'}</td>
            <td style="font-size:12px;color:var(--text-muted)">${t.net_edge_at_entry != null ? `+${(t.net_edge_at_entry * 100).toFixed(1)}¬¢` : '‚Äî'}</td>
            <td><span class="status-tag ${statusClass}">${statusLabel}</span></td>
            <td style="font-weight:700;color:${pnlColor}">${t.pnl_net != null ? fmt$(t.pnl_net, true) : '‚Äî'}</td>
            ${includeSettle && t.status === 'open' ? `
              <td style="white-space:nowrap;">
                <button class="btn btn-sm btn-success" onclick="settleTrade(${t.id},true)" style="margin-right:4px;">Won</button>
                <button class="btn btn-sm btn-danger"  onclick="settleTrade(${t.id},false)">Lost</button>
              </td>` : (includeSettle ? '<td></td>' : '')}
          </tr>`;
        }).join('')}
      </tbody>
    </table>
  </div>`;
}

async function loadTrades() {
  try {
    const [allRes, openRes, settledRes] = await Promise.all([
      api('/api/trades?limit=50'),
      api('/api/trades?status=open&limit=50'),
      api('/api/trades?status=settled&limit=50')
    ]);
    document.getElementById('trades-table-wrapper').innerHTML  = buildTradeTable(allRes.trades, false);
    document.getElementById('open-trades-wrapper').innerHTML   = buildTradeTable(openRes.trades, true);
    document.getElementById('settled-trades-wrapper').innerHTML = buildTradeTable(settledRes.trades, false);
  } catch(e) { console.error('Trades:', e); }
}

async function settleTrade(id, outcome) {
  try {
    const r = await post(`/api/trades/${id}/settle`, { outcome });
    toast(`${outcome ? 'Win' : 'Loss'} recorded ‚Äî P&L: ${fmt$(r.pnl_net, true)}`, outcome ? 'success' : 'error');
    await loadAll();
  } catch(e) {
    toast(`Error: ${e.message}`, 'error');
  }
}

// ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ
async function loadStatus() {
  try {
    const d = await api('/api/system/status');
    const badge  = document.getElementById('status-badge');
    const txt    = document.getElementById('status-text');
    const banner = document.getElementById('cb-banner');
    if (d.status === 'HALTED') {
      badge.className = 'status-badge halted';
      txt.textContent = 'Halted';
      banner.className = 'cb-banner visible';
      document.getElementById('cb-text').textContent =
        `Circuit breaker active: ${d.circuit_breakers.map(b => b.reason).join(', ')}`;
    } else {
      badge.className = 'status-badge running';
      txt.textContent = 'Running';
      banner.className = 'cb-banner';
    }
    document.getElementById('mode-tag').textContent = d.mode || 'PAPER';
  } catch(e) {
    document.getElementById('status-badge').className = 'status-badge halted';
    document.getElementById('status-text').textContent = 'Offline';
  }
}

// ‚îÄ‚îÄ MANUAL TRADE FORM ‚îÄ‚îÄ
document.getElementById('manual-trade-form').addEventListener('submit', async e => {
  e.preventDefault();
  try {
    const body = {
      market_id:        document.getElementById('mt-market-id').value,
      side:             document.getElementById('mt-side').value,
      contracts:        parseInt(document.getElementById('mt-contracts').value),
      price:            parseFloat(document.getElementById('mt-price').value),
      net_edge:         parseFloat(document.getElementById('mt-edge').value) || 0,
      p_model:          parseFloat(document.getElementById('mt-pmodel').value) || 0,
      p_market:         parseFloat(document.getElementById('mt-pmarket').value) || 0,
      reference_period: document.getElementById('mt-period').value,
      notes:            document.getElementById('mt-notes').value
    };
    const r = await post('/api/trades/manual', body);
    toast(`Trade logged (ID: ${r.trade_id})`, 'success');
    e.target.reset();
    await loadAll();
  } catch(e) {
    toast(`Error: ${e.message}`, 'error');
  }
});

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
function switchTab(name, btn) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(`tab-${name}`).classList.add('active');
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
async function loadAll() {
  await Promise.allSettled([
    loadPortfolio(), loadStats(), loadForecasts(),
    loadMarkets(), loadTrades(), loadStatus()
  ]);
}

loadAll();
loadChart(30);
setInterval(loadAll, 60_000);
</script>
</body>
</html>
